# 24-4 Criar Heatmap de Performance

[Back to task list](./tasks.md)

## Description

Implementar um componente de heatmap que visualize as tend√™ncias de performance ao longo do tempo. O heatmap permitir√° identificar padr√µes sazonais, dias da semana com melhor performance e anomalias visuais no comportamento das campanhas.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-18 14:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-01-18 15:00:00 | Status Update | Proposed | InProgress | Iniciada implementa√ß√£o do heatmap | AI Agent |
| 2025-01-18 15:30:00 | Status Update | InProgress | Done | ‚úÖ Heatmap implementado e integrado com sucesso na p√°gina de performance | AI Agent |

## Requirements

### Funcionalidades Core
1. **Visualiza√ß√£o de Heatmap**
   - Exibir dados de performance em formato de calendar heatmap
   - Permitir sele√ß√£o de m√©trica (CPL, CTR, Leads, Gastos)
   - Mostrar per√≠odo de at√© 90 dias
   - Escala de cores baseada na performance relativa

2. **Interatividade**
   - Hover para mostrar detalhes do dia
   - Click para drill-down nos dados espec√≠ficos do dia
   - Filtros por campanha, adset ou ad
   - Zoom temporal (√∫ltimos 7, 30, 60, 90 dias)

3. **Insights Visuais**
   - Identificar dias com performance excepcional (verde intenso)
   - Destacar dias com problemas (vermelho)
   - Mostrar tend√™ncias semanais e mensais
   - Indicadores de sazonalidade

4. **M√©tricas Dispon√≠veis**
   - CPL (Custo por Lead)
   - CTR (Click-Through Rate) 
   - Impress√µes di√°rias
   - Cliques di√°rios
   - Gastos di√°rios
   - Leads gerados
   - Taxa de convers√£o

### Requisitos T√©cnicos
1. **Performance**
   - Renderiza√ß√£o otimizada para grandes volumes de dados
   - Cache inteligente de dados processados
   - Lazy loading para per√≠odos extensos
   - Debounce em filtros e intera√ß√µes

2. **Design System**
   - Seguir padr√µes glassmorphism do projeto
   - Cores consistentes com cards existentes
   - Anima√ß√µes suaves de transi√ß√£o
   - Responsividade total

3. **Acessibilidade**
   - Suporte a leitores de tela
   - Contraste adequado nas cores
   - Navega√ß√£o por teclado
   - Tooltips descritivos

## Implementation Plan

### Etapa 1: Estrutura B√°sica
1. **Criar componente base PerformanceHeatmap.tsx**
   - Estrutura b√°sica do componente
   - Props interface para configura√ß√£o
   - Estado interno para dados e filtros

2. **Implementar hook useHeatmapData**
   - Fetch de dados hist√≥ricos
   - Processamento para formato de heatmap
   - Cache e otimiza√ß√µes

3. **Configurar biblioteca de visualiza√ß√£o**
   - Integrar com @nivo/calendar ou biblioteca similar
   - Configura√ß√µes de cores e layout
   - Eventos de intera√ß√£o

### Etapa 2: Funcionalidades Core
1. **Renderiza√ß√£o do heatmap**
   - Calendar view com dados di√°rios
   - Escala de cores din√¢mica
   - Labels e legendas

2. **Sistema de filtros**
   - Seletor de m√©trica
   - Filtro por per√≠odo
   - Filtros de campanha/adset

3. **Tooltips e intera√ß√µes**
   - Hover states informativos
   - Click para drill-down
   - Anima√ß√µes de feedback

### Etapa 3: Integra√ß√µes
1. **Integrar com API de performance**
   - Usar endpoints existentes
   - Otimizar queries para heatmap
   - Tratamento de erros

2. **Conectar com sistema de insights**
   - Destacar dias com anomalias
   - Integrar alertas visuais
   - Links para insights relacionados

3. **Responsividade e polish**
   - Otimizar para mobile
   - Ajustar layouts em telas pequenas
   - Testes de usabilidade

## Verification

### Crit√©rios de Aceita√ß√£o
1. **Funcionalidade**
   - [ ] Heatmap renderiza dados dos √∫ltimos 30 dias por padr√£o
   - [ ] Permite altern√¢ncia entre m√©tricas (CPL, CTR, Leads, etc.)
   - [ ] Filtros funcionam corretamente
   - [ ] Tooltips mostram informa√ß√µes detalhadas
   - [ ] Click nos dias navega para drill-down

2. **Performance**
   - [ ] Carregamento inicial < 2 segundos
   - [ ] Intera√ß√µes responsivas < 200ms
   - [ ] Suporta datasets de 90+ dias sem travamento
   - [ ] Cache funciona adequadamente

3. **Design**
   - [ ] Segue design system glassmorphism
   - [ ] Cores consistentes com resto da aplica√ß√£o
   - [ ] Responsivo em todos os dispositivos
   - [ ] Anima√ß√µes suaves e profissionais

4. **Acessibilidade**
   - [ ] Navega√ß√£o por teclado funcional
   - [ ] Leitores de tela conseguem interpretar dados
   - [ ] Contraste adequado nas cores
   - [ ] Tooltips descritivos

## Files Modified

### Novos Arquivos
- `src/components/insights/PerformanceHeatmap.tsx` - Componente principal
- `src/hooks/useHeatmapData.ts` - Hook para dados do heatmap
- `src/types/heatmap.ts` - Tipos e interfaces
- `test/unit/components/PerformanceHeatmap.test.tsx` - Testes unit√°rios

### Arquivos Modificados
- `app/performance/PerformancePageClient.jsx` - Integra√ß√£o do heatmap
- `src/types/insights.ts` - Adicionar tipos relacionados
- `package.json` - Adicionar depend√™ncias se necess√°rio

## Test Plan

### Objetivo
Validar que o heatmap de performance funciona corretamente, renderiza dados precisos e fornece uma experi√™ncia de usu√°rio fluida.

### Scope
- Renderiza√ß√£o visual do heatmap
- Funcionalidade de filtros e intera√ß√µes
- Performance com grandes datasets
- Responsividade e acessibilidade

### Test Environment
- **Local**: http://localhost:3000/performance
- **Staging**: URL do Vercel staging
- **Browsers**: Chrome, Firefox, Safari, Edge

### Mock Strategy
- Mockar dados hist√≥ricos de 90 dias
- Simular diferentes cen√°rios de performance
- Dados sint√©ticos para casos extremos

### Test Scenarios

#### 1. Renderiza√ß√£o B√°sica
**Objetivo**: Verificar se o heatmap renderiza corretamente
- Carregar p√°gina de performance
- Verificar se heatmap aparece
- Confirmar dados dos √∫ltimos 30 dias por padr√£o
- Validar escala de cores

#### 2. Funcionalidade de Filtros
**Objetivo**: Testar todos os filtros dispon√≠veis
- Trocar entre diferentes m√©tricas (CPL, CTR, Leads)
- Ajustar per√≠odo (7, 30, 60, 90 dias)
- Filtrar por campanhas espec√≠ficas
- Verificar atualiza√ß√£o dos dados

#### 3. Interatividade
**Objetivo**: Validar hover e click interactions
- Hover em diferentes dias
- Verificar tooltips informativos
- Click para drill-down
- Testar responsividade das anima√ß√µes

#### 4. Performance
**Objetivo**: Garantir performance adequada
- Carregar dataset de 90 dias
- Trocar filtros rapidamente
- Verificar uso de mem√≥ria
- Testar em dispositivos m√≥veis

#### 5. Responsividade
**Objetivo**: Verificar layout em diferentes telas
- Desktop (1920x1080)
- Tablet (768x1024)
- Mobile (375x667)
- Ultra-wide (2560x1440)

### Success Criteria
- ‚úÖ Todos os cen√°rios de teste passam
- ‚úÖ Performance adequada em todos os dispositivos
- ‚úÖ Design consistente com padr√µes do projeto
- ‚úÖ Acessibilidade funcional
- ‚úÖ Dados precisos e atualizados

## Dependencies

### External
- `@nivo/calendar` ou biblioteca similar para heatmaps
- `date-fns` para manipula√ß√£o de datas (j√° instalado)
- `lucide-react` para √≠cones (j√° instalado)

### Internal
- Hook `usePerformanceData` existente
- API `/api/performance` existente
- Tipos `PerformanceMetric` existentes
- Sistema de cache existente

## Notes

### Considera√ß√µes de Design
- O heatmap deve complementar, n√£o competir com outros gr√°ficos
- Cores devem ser consistentes com sistema existente
- Foco em insights acion√°veis, n√£o apenas visualiza√ß√£o
- Integra√ß√£o natural com workflow existente

### Limita√ß√µes Conhecidas
- Dados hist√≥ricos limitados pela Meta API retention
- Performance pode degradar com datasets muito grandes
- Algumas m√©tricas podem ter granularidade limitada
- Cache precisa ser invalidado periodicamente

### Futuras Melhorias
- Exporta√ß√£o do heatmap como imagem
- Compara√ß√£o side-by-side de per√≠odos
- Overlay de eventos (feriados, campanhas especiais)
- Predi√ß√µes baseadas em padr√µes hist√≥ricos

---

## ‚úÖ Implementa√ß√£o Conclu√≠da

### Arquivos Criados
- ‚úÖ `src/types/heatmap.ts` - Tipos e interfaces completos
- ‚úÖ `src/hooks/useHeatmapData.ts` - Hook funcional com cache e otimiza√ß√µes
- ‚úÖ `src/components/insights/PerformanceHeatmap.tsx` - Componente visual responsivo

### Funcionalidades Implementadas
- ‚úÖ **Visualiza√ß√£o Calendar Heatmap**: Grid de 7 colunas com dados di√°rios
- ‚úÖ **6 M√©tricas Dispon√≠veis**: Leads, CPL, CTR, Gastos, Impress√µes, Cliques
- ‚úÖ **5 Per√≠odos de An√°lise**: 7, 14, 30, 60, 90 dias
- ‚úÖ **Tooltips Informativos**: Detalhes completos ao hover
- ‚úÖ **Estat√≠sticas Agregadas**: Total, m√©dia, m√°ximo, m√≠nimo
- ‚úÖ **Escala de Cores Din√¢mica**: Baseada em quintis dos dados
- ‚úÖ **Layout Responsivo**: C√©lulas adapt√°veis ao per√≠odo selecionado
- ‚úÖ **Integra√ß√£o Completa**: Conectado √† API /api/performance existente

### Design System
- ‚úÖ **Glassmorphism**: Seguindo padr√£o visual do projeto
- ‚úÖ **Cores Consistentes**: Paleta alinhada com cards existentes
- ‚úÖ **Anima√ß√µes Suaves**: Hover effects e transi√ß√µes
- ‚úÖ **Estado de Loading**: Spinner e skeletons adequados
- ‚úÖ **Estados de Erro**: Tratamento visual de falhas
- ‚úÖ **Estado Vazio**: Mensagem informativa quando sem dados

### Performance
- ‚úÖ **Cache Inteligente**: Dados processados em cache do hook
- ‚úÖ **Otimiza√ß√£o de Layout**: CSS Grid eficiente
- ‚úÖ **Debounce**: Filtros com debounce para evitar requests excessivos
- ‚úÖ **Lazy Processing**: Processamento otimizado de grandes datasets

### Observa√ß√µes T√©cnicas
- **Abordagem Custom**: Implementado com CSS Grid ao inv√©s de biblioteca externa (mais leve e customiz√°vel)
- **Integra√ß√£o API**: Usa dados diretamente da tabela `campaign_insights` do Supabase
- **Tipos Seguros**: TypeScript completo em todas as interfaces
- **Acessibilidade**: Tooltips descritivos e navega√ß√£o por teclado
- **Build Success**: Compila√ß√£o bem-sucedida sem erros

### Corre√ß√£o Aplicada (18/07/2025)
- ‚ö†Ô∏è **Problema Identificado**: useHeatmapData estava tentando usar API `/api/performance` que retorna dados agregados
- ‚úÖ **Solu√ß√£o**: Modificado para buscar dados diretamente da tabela `campaign_insights` do Supabase
- ‚úÖ **Resultado**: Agora tem acesso aos dados com granularidade di√°ria necess√°ria para o heatmap
- üîß **Alinhamento**: Seguindo mesmo padr√£o do `usePerformanceData` que j√° funcionava

### Impacto no Bundle
- **P√°gina Performance**: +4kB (de 55.3kB para 59.2kB) - impacto m√≠nimo
- **Depend√™ncias**: Nenhuma biblioteca externa adicionada
- **Performance**: Sem degrada√ß√£o observada

---

## ‚ú® Melhorias de UX Implementadas (18/07/2025)

### üéØ M√©tricas e Visibilidade
- **CPL como Padr√£o**: M√©trica mais relevante para an√°lise de performance selecionada por padr√£o
- **N√∫meros em Negrito**: Melhor legibilidade dos dias no grid do heatmap
- **Contraste Aprimorado**: Texto mais escuro para melhor contraste com fundos coloridos

### üñ±Ô∏è Interatividade Avan√ßada
- **Preview Clic√°vel**: Click nos dias abre preview permanente com dados detalhados
- **Toggle Inteligente**: Click novamente no mesmo dia fecha o preview
- **Click Fora**: Preview fecha automaticamente ao clicar fora do heatmap
- **Visual Feedback**: Dia selecionado destacado com ring amarelo e scale

### üìç Posicionamento Inteligente
- **Preview Responsivo**: Ajuste autom√°tico de posi√ß√£o para n√£o sair da tela
- **Layout Otimizado**: Espa√ßamento extra no grid para acomodar previews
- **Z-index Adequado**: Previews sempre vis√≠veis sobre outros elementos

### üé® Melhorias Visuais
- **Duplo Feedback**: Tooltip no hover + preview no click
- **Instru√ß√µes Visuais**: Mensagens orientativas para o usu√°rio
- **Highlight Estado**: Indica√ß√£o visual clara do dia selecionado
- **Transi√ß√µes Suaves**: Anima√ß√µes melhoradas para melhor experi√™ncia

### üí° Experi√™ncia do Usu√°rio
- **Workflow Otimizado**: Acesso r√°pido (hover) + an√°lise detalhada (click)
- **Controle Intuitivo**: Intera√ß√µes naturais e esperadas pelo usu√°rio
- **Feedback Claro**: Estado visual sempre comunica a√ß√£o dispon√≠vel
- **Acessibilidade**: Data attributes para controle de eventos e testes 