# 24-8 Corrigir Erros de Console - Anomalias e Gr√°ficos SVG

## Description

Corrigir os erros cr√≠ticos identificados no console do navegador relacionados ao sistema de detec√ß√£o de anomalias e aos gr√°ficos SVG que est√£o causando problemas de experi√™ncia do usu√°rio.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 21:00:00 | Created | N/A | Proposed | Task criada para corrigir erros de console identificados | AI Agent |

## Requirements

### Erros Identificados no Console

1. **üî¥ Erro de Conex√£o com API de Anomalias**
   ```
   üîç [useAnomalyDetection] Erro non-critical: Erro de conex√£o com a API de anomalias. Verifique sua conex√£o ou tente novamente.
   ```
   - **Local**: `src/hooks/useAnomalyDetection.ts`
   - **Causa**: Timeout ou falha na conex√£o com `/api/ai/anomalies`
   - **Impacto**: Sistema de detec√ß√£o de anomalias n√£o funciona

2. **üî¥ Erro de Gr√°ficos SVG - Path Null**
   ```
   Error: <path> attribute d: Expected moveto path command ('M' or 'm'), "null".
   ```
   - **Local**: Componentes de gr√°ficos (`@nivo/line`, `react-spring`)
   - **Causa**: Dados inv√°lidos ou nulos sendo passados para gr√°ficos
   - **Impacto**: Gr√°ficos n√£o renderizam corretamente

3. **üî¥ Sistema de Previs√µes Retornando 0 Dados**
   ```
   üìä Forecast leads: 0 dados brutos ‚Üí 0 dados limpos
   üìä Forecast spend: 0 dados brutos ‚Üí 0 dados limpos
   ```
   - **Local**: `/api/performance/forecast`
   - **Causa**: Consulta n√£o encontra dados na tabela `campaign_insights`
   - **Impacto**: Previs√µes vazias ou incorretas

## Implementation Plan

### Fase 1: Corre√ß√£o da API de Anomalias (1 hora)

1. **Investigar endpoint `/api/ai/anomalies`** (30 min)
   - Verificar se endpoint existe e est√° funcionando
   - Analisar logs de erro do servidor
   - Verificar configura√ß√£o do OpenAI

2. **Implementar fallback graceful** (30 min)
   - Melhorar tratamento de erro no hook
   - Adicionar estado de "modo offline"
   - Evitar spam de requisi√ß√µes falhadas

### Fase 2: Corre√ß√£o dos Gr√°ficos SVG (1 hora)

3. **Validar dados dos gr√°ficos** (30 min)
   - Adicionar valida√ß√£o robusta nos componentes `AnimatedLineChart`, `AnimatedPieChart`, `AnimatedBarChart`
   - Verificar dados nulos/undefined antes de renderizar
   - Implementar fallbacks para dados vazios

4. **Corrigir componente PerformanceForecast** (30 min)
   - Validar dados do forecast antes de passar para gr√°ficos
   - Adicionar verifica√ß√µes de tipo
   - Implementar loading states adequados

### Fase 3: Corre√ß√£o do Sistema de Previs√µes (30 min)

5. **Debugar consulta da API forecast** (30 min)
   - Verificar se a query est√° buscando na tabela correta
   - Analisar per√≠odo de datas usado na consulta
   - Verificar se h√° dados dispon√≠veis para o per√≠odo

## Verification

### Crit√©rios de Aceita√ß√£o
- [ ] Console limpo sem erros relacionados a anomalias
- [ ] Gr√°ficos SVG renderizam sem erros de path null
- [ ] Sistema de previs√µes busca dados corretamente
- [ ] Fallbacks adequados para dados indispon√≠veis
- [ ] Mensagens de erro amig√°veis para o usu√°rio
- [ ] Performance n√£o impactada pelas corre√ß√µes

### Testes de Valida√ß√£o

#### Teste 1: API de Anomalias
- **A√ß√£o**: Acessar p√°gina de performance
- **Verifica√ß√£o**: N√£o deve aparecer erro de conex√£o no console
- **Fallback**: Se API indispon√≠vel, deve mostrar mensagem amig√°vel

#### Teste 2: Gr√°ficos SVG
- **A√ß√£o**: Navegar por todas as p√°ginas com gr√°ficos
- **Verifica√ß√£o**: Nenhum erro de "path null" no console
- **Dados Vazios**: Deve mostrar placeholder apropriado

#### Teste 3: Sistema de Previs√µes
- **A√ß√£o**: Acessar componente de previs√µes
- **Verifica√ß√£o**: Deve buscar dados ou mostrar mensagem informativa
- **Logs**: N√£o deve mostrar "0 dados brutos" se houver dados dispon√≠veis

## Files Modified

### Arquivos Principais
- `src/hooks/useAnomalyDetection.ts` - Melhorar tratamento de erros
- `src/components/ui/AnimatedLineChart.jsx` - Valida√ß√£o de dados
- `src/components/ui/AnimatedPieChart.jsx` - Valida√ß√£o de dados  
- `src/components/ui/AnimatedBarChart.jsx` - Valida√ß√£o de dados
- `src/components/insights/PerformanceForecast.tsx` - Valida√ß√£o do forecast
- `app/api/performance/forecast/route.ts` - Debug da consulta

### Poss√≠veis Novos Arquivos
- `src/utils/chartDataValidation.ts` - Utilit√°rios de valida√ß√£o para gr√°ficos
- `src/components/ui/ChartFallback.tsx` - Componente de fallback para gr√°ficos

## Test Plan

### Objective
Eliminar todos os erros de console relacionados a anomalias e gr√°ficos, garantindo uma experi√™ncia limpa para o usu√°rio.

### Scope
- Sistema de detec√ß√£o de anomalias
- Todos os componentes de gr√°ficos da aplica√ß√£o
- Sistema de previs√µes de performance
- Tratamento de dados nulos/vazios

### Test Scenarios

#### Cen√°rio 1: Console Limpo
- **Setup**: Acessar todas as p√°ginas da aplica√ß√£o
- **Expected**: Nenhum erro relacionado a gr√°ficos ou anomalias no console
- **Validation**: Console.error deve estar vazio

#### Cen√°rio 2: Dados Indispon√≠veis
- **Setup**: Simular aus√™ncia de dados para gr√°ficos
- **Expected**: Placeholder adequado sem erros
- **Validation**: UI deve degradar graciosamente

#### Cen√°rio 3: API Offline
- **Setup**: Simular falha na API de anomalias
- **Expected**: Mensagem amig√°vel sem spam de requests
- **Validation**: Hook deve parar tentativas ap√≥s algumas falhas

#### Cen√°rio 4: Previs√µes com Dados
- **Setup**: Garantir que h√° dados na tabela campaign_insights
- **Expected**: Sistema deve encontrar e processar dados
- **Validation**: Logs devem mostrar dados encontrados

### Criteria for Success
- ‚úÖ Zero erros de console relacionados a path="null"
- ‚úÖ Zero erros de conex√£o com API de anomalias  
- ‚úÖ Sistema de previs√µes funciona com dados dispon√≠veis
- ‚úÖ Fallbacks elegantes para todos os cen√°rios de erro
- ‚úÖ Performance mantida ou melhorada
- ‚úÖ UX n√£o degradada pelos tratamentos de erro

## Notes

### Prioridade Alta
Estes erros afetam diretamente a experi√™ncia do usu√°rio e podem indicar problemas mais profundos no sistema.

### Depend√™ncias
- Dados na tabela `campaign_insights` para testes do sistema de previs√µes
- OpenAI API configurada para testes de anomalias

### Riscos
- Corre√ß√µes podem mascarar problemas de dados subjacentes
- Over-engineering do tratamento de erros pode complicar o c√≥digo

### Observa√ß√µes T√©cnicas
- Focar em corre√ß√µes que melhorem a robustez sem afetar performance
- Manter logs informativos para debugging futuro
- Garantir que fallbacks sejam informativos para o usu√°rio 