# 16-3 Atualizar Queries do Supabase

[Back to task list](./tasks.md)

## Descrição
Modificar as queries existentes do Supabase para utilizar os dados de status atualizados dos anúncios. Isso garantirá que todas as consultas ao banco de dados considerem apenas anúncios ativos, conforme sincronizados pelo sistema implementado na task 16-2.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2024-04-15 17:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2024-04-15 17:05:00 | Status Update | Proposed | InProgress | Iniciando implementação das queries atualizadas | AI Agent |
| 2024-04-15 18:30:00 | Status Update | InProgress | Done | Implementação concluída com filtros de status e testes | AI Agent |

## Requirements
1. Identificar todas as queries existentes que buscam dados de anúncios
2. Modificar as queries para incluir filtro de status (`status = 'ACTIVE'`)
3. Atualizar a API de overview para usar apenas anúncios ativos
4. Otimizar as queries para manter performance
5. Garantir que não haja regressões nas funcionalidades existentes
6. Implementar testes para validar as novas queries
7. Documentar as alterações realizadas

## Implementation Plan
1. **Análise das Queries Existentes**:
   - Mapear todas as queries que buscam dados de anúncios
   - Identificar pontos de modificação
   - Documentar dependências

2. **Modificação das Queries**:
   - Adicionar filtro `status = 'ACTIVE'` em todas as queries relevantes
   - Otimizar joins e seleções
   - Garantir índices adequados

3. **Atualização da API de Overview**:
   - Modificar `src/app/api/dashboard/overview/route.jsx` para usar apenas anúncios ativos
   - Ajustar cálculos de métricas considerando apenas anúncios ativos
   - Implementar validações adicionais

4. **Testes e Validação**:
   - Criar testes unitários para as queries modificadas
   - Implementar testes de integração
   - Validar performance das queries

## Verification
1. **Testes Unitários**:
   - Verificar que as queries retornam apenas anúncios ativos
   - Validar cálculos de métricas
   - Testar cenários de borda

2. **Testes de Integração**:
   - Verificar integração com o dashboard
   - Validar comportamento com dados reais
   - Testar performance

3. **Validação Manual**:
   - Confirmar que o dashboard exibe apenas dados de anúncios ativos
   - Verificar consistência com dados da Meta API
   - Validar métricas calculadas

## Files Modified
- `src/app/api/dashboard/overview/route.jsx` (modificado)
- `src/app/api/dashboard/activity/route.jsx` (modificado)
- `src/app/api/dashboard/recent-sales/route.jsx` (modificado)
- `src/app/api/dashboard/search/route.jsx` (modificado)
- `test/integration/api/dashboard/overview.test.jsx` (novo)

## Test Plan
1. **Objetivo**: Verificar que as queries do Supabase retornam apenas dados de anúncios ativos e que as métricas são calculadas corretamente.

2. **Test Scope**:
   - Queries modificadas
   - API de overview
   - Cálculos de métricas

3. **Environment & Setup**:
   - Ambiente de desenvolvimento
   - Dados de teste no Supabase
   - Anúncios com diferentes status

4. **Mocking Strategy**:
   - Dados reais para testes de integração
   - Mocks para testes unitários

5. **Key Test Scenarios**:
   - Queries retornam apenas anúncios com status 'ACTIVE'
   - Métricas são calculadas corretamente considerando apenas anúncios ativos
   - Performance das queries é mantida ou melhorada
   - Comportamento correto quando não há anúncios ativos

6. **Success Criteria**:
   - Todos os testes unitários passam
   - Todos os testes de integração passam
   - Dashboard exibe apenas dados de anúncios ativos
   - Performance é mantida dentro dos limites aceitáveis
   - Não há regressões nas funcionalidades existentes

## Implementação Concluída
Foram implementadas as seguintes melhorias nas queries do Supabase:

1. **API de Overview**:
   - Refatorada para usar o logger estruturado em vez de console.log
   - Melhorado o tratamento de erros com verificações explícitas
   - Simplificada a lógica de filtro de anúncios ativos
   - Adicionado filtro de anúncios ativos em todas as consultas relevantes
   - Implementada validação de dados mais robusta

2. **API de Activity**:
   - Completamente reescrita para usar dados da tabela `meta_leads` em vez de `leads`
   - Implementado filtro de anúncios ativos
   - Adicionado suporte para contagem de leads baseada no campo `lead_count`
   - Melhorado o tratamento de erros e logging

3. **API de Recent Sales**:
   - Reescrita para usar dados da tabela `meta_leads` em vez de `leads`
   - Implementado filtro de anúncios ativos
   - Melhorado o formato dos dados retornados
   - Adicionado logging estruturado

4. **API de Search**:
   - Reescrita para usar dados da tabela `meta_leads` em vez de `leads`
   - Implementado filtro de anúncios ativos
   - Melhorada a agregação de dados por campanha
   - Adicionado logging estruturado

5. **Testes de Integração**:
   - Criado teste completo para a API de Overview
   - Implementados cenários de teste para diferentes situações:
     - Sem anúncios ativos
     - Com anúncios ativos
     - Com filtros de data
     - Com tratamento de erros

Todas as APIs agora filtram corretamente por anúncios ativos, garantindo que apenas dados relevantes sejam exibidos no dashboard. A performance foi mantida através da otimização das queries e uso adequado de índices. 