# 25-5 Desenvolver sistema de an√°lise de qualidade de leads

## Description

Implementar um sistema de scoring de qualidade de leads baseado em dados hist√≥ricos de convers√£o, enriquecendo cada lead com um score e logs de qualidade. O sistema deve calcular m√©tricas agregadas por adset/campanha, registrar logs para auditoria e expor APIs para consulta de score individual e relat√≥rios de qualidade.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-22 18:30:00 | Created | N/A | Proposed | Task criada para an√°lise de qualidade de leads | AI Agent |
| 2025-01-22 18:31:00 | Status Change | Proposed | InProgress | Iniciando especifica√ß√£o e arquitetura do sistema de scoring | AI Agent |
| 2025-01-22 19:00:00 | Status Change | InProgress | Review | Migrations, tipos, servi√ßo, APIs de scoring e logs implementados | AI Agent |

## Requirements

### Functional Requirements
1. **C√°lculo de score de qualidade** para cada lead ‚úÖ
2. **Registro de score e logs** para cada lead ‚úÖ
3. **M√©tricas agregadas** de qualidade por adset/campanha ‚úÖ
4. **API para consulta de score individual** ‚úÖ
5. **API para relat√≥rios de qualidade agregada** ‚úÖ
6. **Logs de auditoria** para altera√ß√µes de score ‚úÖ

### Technical Requirements
1. **Campo de score** na tabela de leads (`quality_score`) ‚úÖ
2. **Tabela de logs de qualidade** (`lead_quality_logs`) ‚úÖ
3. **Servi√ßo de c√°lculo de score** (Node.js/TypeScript) ‚úÖ
4. **APIs para consulta de score e logs** ‚úÖ
5. **Performance**: c√°lculo para at√© 10.000 leads/dia (testar em produ√ß√£o)
6. **Logs detalhados** de execu√ß√µes e altera√ß√µes ‚úÖ

### Business Rules
1. **Score de 0 a 100** (quanto maior, melhor)
2. **Score inicial** baseado em m√©dia hist√≥rica do adset/campanha
3. **Penalidades** para leads duplicados, rejeitados, dados incompletos
4. **Recalcular score** ao atualizar status do lead ‚úÖ
5. **Registrar motivo de altera√ß√£o no log** ‚úÖ

## Implementation Progress

### ‚úÖ Completed
- Migration: `add_quality_score_to_leads.sql` (campo score)
- Migration: `create_lead_quality_logs.sql` (logs de score)
- Tipos TypeScript: `src/types/leadQuality.ts`
- Servi√ßo: `src/services/leadQualityService.ts` (c√°lculo, penalidades, logs)
- API: `/api/leads/[lead_id]/quality` (score individual)
- API: `/api/leads/quality/report` (relat√≥rio agregado)
- API: `/api/leads/[lead_id]/quality/recalculate` (rec√°lculo/manual)

### üîÑ Next Steps
- Testar performance com 10.000 leads
- Integra√ß√£o visual no dashboard
- Auditoria de logs e relat√≥rios

## Files Modified

### New Files ‚úÖ
- `supabase/migrations/20250122_add_quality_score_to_leads.sql`
- `supabase/migrations/20250122_create_lead_quality_logs.sql`
- `src/types/leadQuality.ts`
- `src/services/leadQualityService.ts`
- `app/api/leads/[lead_id]/quality/route.ts`
- `app/api/leads/quality/report/route.ts`
- `app/api/leads/[lead_id]/quality/recalculate/route.ts`

## Test Plan

### Objective
Verificar que o sistema de scoring calcula corretamente a qualidade dos leads, aplica penalidades, registra logs e exp√µe APIs para consulta e relat√≥rios.

### Scope
- C√°lculo de score
- Penalidades e logs
- APIs de consulta e relat√≥rio

### Key Test Scenarios

1. **Lead com alta convers√£o hist√≥rica**: Score alto (>80)
2. **Lead duplicado/rejeitado**: Score penalizado (<50)
3. **Lead com dados incompletos**: Score penalizado (<60)
4. **Lead convertido rapidamente**: Score elevado (>90)
5. **Recalcular score ap√≥s atualiza√ß√£o**: Score e log atualizados
6. **Relat√≥rio agregado**: Score m√©dio, distribui√ß√£o, % leads de alta/baixa qualidade

### Success Criteria
- Score de 0 a 100 para todos os leads
- Penalidades aplicadas corretamente
- Logs completos de altera√ß√µes
- APIs retornam dados corretos
- Performance adequada

---

[Back to task list](./tasks.md) 