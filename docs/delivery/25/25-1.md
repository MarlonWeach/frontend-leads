# 25-1 Criar interface de configura√ß√£o de metas por adset

## Description

Implementar uma interface completa para configura√ß√£o de metas contratuais por adset, permitindo que gestores definam budget total, CPL alvo, volume de leads contratado, per√≠odo contratual e volume j√° captado pelo cliente. O sistema deve calcular automaticamente quantos leads s√£o necess√°rios por dia e validar todos os campos obrigat√≥rios.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-22 15:00:00 | Created | N/A | Proposed | Task criada para implementar interface de metas | AI Agent |
| 2025-01-22 15:30:00 | Status Change | Proposed | InProgress | Iniciando implementa√ß√£o da interface | AI Agent |
| 2025-01-22 16:15:00 | Status Change | InProgress | Review | Backend implementado - migration, API, types, hook criados | AI Agent |

## Requirements

### Functional Requirements
1. **Formul√°rio de configura√ß√£o por adset** com campos:
   - Budget Total (R$)
   - CPL Alvo (R$)
   - Volume de Leads Contratado (n√∫mero)
   - Data de In√≠cio do Contrato
   - Data de Fim do Contrato
   - Volume j√° Captado pelo Cliente (atualiza√ß√£o manual)

2. **C√°lculo autom√°tico** de leads necess√°rios por dia baseado em:
   - Dias restantes no contrato
   - Volume total contratado
   - Volume j√° captado
   - Performance atual do adset

3. **Valida√ß√µes obrigat√≥rias**:
   - Todos os campos devem ser preenchidos
   - Data fim deve ser posterior √† data in√≠cio
   - Values num√©ricos devem ser positivos
   - CPL alvo deve ser realista (n√£o muito baixo)

4. **Interface responsiva** que funcione em desktop e mobile

### Technical Requirements
1. **Frontend**: React/Next.js component
2. **Styling**: Tailwind CSS seguindo design system existente
3. **Validation**: Formik + Yup para valida√ß√£o de formul√°rios
4. **State Management**: React hooks (useState, useEffect)
5. **API Integration**: Endpoints para salvar/buscar configura√ß√µes
6. **Database**: PostgreSQL table para armazenar metas

### Business Rules
1. **C√°lculo de leads por dia**:
   ```
   leads_necessarios_por_dia = (volume_contratado - volume_captado) / dias_restantes
   ```

2. **Alertas de viabilidade**:
   - Se CPL alvo * leads_por_dia > budget_diario: mostrar alerta
   - Se leads_por_dia > capacidade_historica_adset: mostrar warning

3. **Margem de seguran√ßa**:
   - Recomendar 10-15% de buffer no c√°lculo de budget

## Implementation Plan

### Phase 1: Database Schema ‚úÖ
1. **Criar tabela `adset_goals`** ‚úÖ:
   ```sql
   CREATE TABLE adset_goals (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     adset_id VARCHAR NOT NULL,
     budget_total DECIMAL(10,2) NOT NULL,
     cpl_target DECIMAL(8,2) NOT NULL,
     volume_contracted INTEGER NOT NULL,
     volume_captured INTEGER DEFAULT 0,
     contract_start_date DATE NOT NULL,
     contract_end_date DATE NOT NULL,
     created_at TIMESTAMP DEFAULT NOW(),
     updated_at TIMESTAMP DEFAULT NOW()
   );
   ```

2. **Indexes e constraints** ‚úÖ:
   ```sql
   CREATE UNIQUE INDEX idx_adset_goals_adset_id ON adset_goals(adset_id);
   ALTER TABLE adset_goals ADD CONSTRAINT valid_dates 
     CHECK (contract_end_date > contract_start_date);
   ```

### Phase 2: Backend API ‚úÖ
1. **Criar endpoints** em `/app/api/goals/` ‚úÖ:
   - `POST /api/goals` - Criar/atualizar meta
   - `GET /api/goals/[adset_id]` - Buscar meta espec√≠fica
   - `GET /api/goals` - Listar todas as metas
   - `DELETE /api/goals/[adset_id]` - Remover meta

2. **Validation rules** no backend ‚úÖ:
   - Verificar se adset_id existe na Meta API
   - Validar datas e valores num√©ricos
   - Calcular m√©tricas derivadas

### Phase 3: Frontend Components ‚è≥
1. **Componente principal**: `GoalConfigurationForm.tsx`
2. **Subcomponentes**:
   - `BudgetInput.tsx` - Input formatado para moeda
   - `DateRangePicker.tsx` - Seletor de per√≠odo
   - `LeadsCalculator.tsx` - Display do c√°lculo autom√°tico
   - `ValidationSummary.tsx` - Resumo de alertas/warnings

### Phase 4: Integration ‚è≥
1. **Integrar com p√°gina de adsets existente**
2. **Adicionar bot√£o "Configurar Metas"** na listagem de adsets
3. **Modal ou p√°gina dedicada** para o formul√°rio
4. **Feedback visual** de sucesso/erro

## Verification

### Unit Tests
- [ ] Valida√ß√£o de formul√°rio com dados v√°lidos
- [ ] Valida√ß√£o com dados inv√°lidos (datas, valores)
- [ ] C√°lculo correto de leads por dia
- [ ] Formata√ß√£o de moeda e n√∫meros

### Integration Tests
- [ ] Salvar meta via API
- [ ] Buscar meta existente
- [ ] Atualizar meta existente
- [ ] Valida√ß√£o de adset_id via Meta API

### E2E Tests
- [ ] Fluxo completo: abrir formul√°rio ‚Üí preencher ‚Üí salvar
- [ ] Valida√ß√£o de campos obrigat√≥rios
- [ ] C√°lculo autom√°tico funcionando
- [ ] Responsividade em mobile

### Manual Testing
- [ ] Interface segue design system do projeto
- [ ] Formul√°rio √© intuitivo e f√°cil de usar
- [ ] Mensagens de erro s√£o claras
- [ ] Performance adequada com m√∫ltiplos adsets

## Files Modified

### New Files ‚úÖ
- `supabase/migrations/20250122_create_adset_goals_table.sql` - Migration para tabela de metas
- `src/types/goals.ts` - Tipos TypeScript completos para sistema de metas
- `app/api/goals/route.ts` - API endpoints principais para metas
- `app/api/goals/[adset_id]/route.ts` - API espec√≠fica por adset
- `src/hooks/useGoals.ts` - Hook React para gerenciar estado de metas

### New Files (Pendentes)
- `src/components/goals/GoalConfigurationForm.tsx` - Componente principal
- `src/components/goals/BudgetInput.tsx` - Input de moeda
- `src/components/goals/LeadsCalculator.tsx` - Calculadora de leads
- `src/components/goals/ValidationSummary.tsx` - Resumo de alertas

### Modified Files (Pendentes)
- `app/adsets/page.tsx` - Adicionar bot√£o "Configurar Metas"
- `src/components/ui/Modal.tsx` - Modal para formul√°rio (se n√£o existir)

## Implementation Progress

### ‚úÖ Completed
1. **Database Schema**: Tabela `adset_goals` criada com todos os constraints e indexes
2. **TypeScript Types**: Tipos completos para metas, valida√ß√µes, c√°lculos e API responses
3. **Backend API**: Endpoints completos para CRUD de metas com valida√ß√µes robustas
4. **React Hook**: Hook `useGoals` com todas as opera√ß√µes e valida√ß√µes
5. **Business Logic**: C√°lculos autom√°ticos de leads por dia e m√©tricas derivadas

### üîÑ Next Steps
1. **Create Frontend Components**: Formul√°rio e subcomponentes
2. **Integration**: Integrar com p√°gina de adsets existente
3. **Testing**: Implementar testes unit√°rios e E2E
4. **Validation**: Testar fluxo completo

### üìä Progress Status
**Backend**: 100% conclu√≠do  
**Types**: 100% conclu√≠do  
**Frontend**: 0% (pr√≥xima fase)  
**Integration**: 0% (pr√≥xima fase)  
**Testing**: 0% (pr√≥xima fase)

**Overall Progress**: ~40% conclu√≠do

## Test Plan

### Objective
Verificar que a interface de configura√ß√£o de metas funciona corretamente, calcula leads por dia automaticamente e valida todos os campos conforme especificado.

### Scope
- Formul√°rio de configura√ß√£o de metas
- C√°lculos autom√°ticos
- Valida√ß√µes de campos
- Integra√ß√£o com API

### Environment & Setup
- Ambiente de desenvolvimento local
- Database com dados de teste
- Mock da Meta API para valida√ß√£o de adsets

### Mock Strategy
- Mock do Supabase para testes unit√°rios
- Mock da Meta API para valida√ß√£o de adset_id
- Dados de teste com cen√°rios variados

### Key Test Scenarios

1. **Configura√ß√£o Nova Meta**:
   - Abrir formul√°rio para adset sem meta configurada
   - Preencher todos os campos obrigat√≥rios
   - Verificar c√°lculo autom√°tico de leads por dia
   - Salvar e confirmar persist√™ncia

2. **Edi√ß√£o Meta Existente**:
   - Abrir formul√°rio para adset com meta existente
   - Verificar pr√©-preenchimento dos campos
   - Alterar valores e verificar rec√°lculo autom√°tico
   - Salvar altera√ß√µes

3. **Valida√ß√µes de Campos**:
   - Tentar salvar com campos obrigat√≥rios vazios
   - Inserir datas inv√°lidas (fim antes do in√≠cio)
   - Inserir valores negativos ou zero
   - Verificar mensagens de erro apropriadas

4. **Cen√°rios de Neg√≥cio**:
   - Meta muito ambiciosa (CPL muito baixo)
   - Per√≠odo muito curto para volume alto
   - Volume j√° captado pr√≥ximo do contratado
   - Verificar alertas e warnings

### Success Criteria
- Formul√°rio salva e carrega dados corretamente
- C√°lculos autom√°ticos est√£o precisos
- Valida√ß√µes funcionam conforme especificado
- Interface √© responsiva e intuitiva
- Performance adequada (< 2s para carregar/salvar)

---

[Back to task list](./tasks.md) 