name: ğŸ” Auditoria DiÃ¡ria - Meta API vs Supabase

on:
  schedule:
    # Executa todos os dias Ã s 3h UTC (meia-noite BRT)
    - cron: '0 3 * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual
  push:
    branches: [ main ]
    paths:
      - 'scripts/audit-daily.js'
      - '.github/workflows/audit-daily.yml'

env:
  NODE_VERSION: '18'

jobs:
  audit:
    name: Executar Auditoria DiÃ¡ria
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        echo "âœ… DependÃªncias instaladas"
        
    - name: ğŸ”§ Setup environment
      run: |
        echo "ğŸ”§ Configurando variÃ¡veis de ambiente..."
        # Verificar se as variÃ¡veis necessÃ¡rias estÃ£o definidas
        if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then
          echo "âŒ NEXT_PUBLIC_SUPABASE_URL nÃ£o definida"
          exit 1
        fi
        if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
          echo "âŒ SUPABASE_SERVICE_ROLE_KEY nÃ£o definida"
          exit 1
        fi
        if [ -z "${{ secrets.META_ACCESS_TOKEN }}" ]; then
          echo "âŒ META_ACCESS_TOKEN nÃ£o definida"
          exit 1
        fi
        if [ -z "${{ secrets.META_ACCOUNT_ID }}" ]; then
          echo "âŒ META_ACCOUNT_ID nÃ£o definida"
          exit 1
        fi
        echo "âœ… Todas as variÃ¡veis de ambiente estÃ£o definidas"
        
    - name: ğŸ§ª Test script execution
      run: |
        echo "ğŸ§ª Testando execuÃ§Ã£o do script..."
        node scripts/audit-daily.js --test || echo "âš ï¸ Script pode ter problemas (continuando mesmo assim)"
        
    - name: ğŸ” Run daily audit
      id: audit
      run: |
        echo "ğŸš€ Iniciando auditoria diÃ¡ria..."
        echo "ğŸ“… Data/Hora: $(date)"
        echo "ğŸ”„ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Executor: ${{ github.actor }}"
        
        # Executar auditoria e capturar saÃ­da
        OUTPUT=$(node scripts/audit-daily.js 2>&1)
        EXIT_CODE=$?
        
        # Salvar saÃ­da para uso posterior
        echo "audit_output<<EOF" >> $GITHUB_OUTPUT
        echo "$OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Salvar saÃ­da em arquivo para upload
        echo "$OUTPUT" > audit-output.log
        
        # Verificar se houve divergÃªncias
        if echo "$OUTPUT" | grep -q "DIVERGÃŠNCIAS ENCONTRADAS"; then
          echo "has_discrepancies=true" >> $GITHUB_OUTPUT
          echo "âŒ DivergÃªncias detectadas!"
        else
          echo "has_discrepancies=false" >> $GITHUB_OUTPUT
          echo "âœ… Paridade total - Sem divergÃªncias"
        fi
        
        # Retornar cÃ³digo de saÃ­da
        exit $EXIT_CODE
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
        META_ACCOUNT_ID: ${{ secrets.META_ACCOUNT_ID }}
        
    - name: ğŸ“¤ Upload audit logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: audit-logs-${{ github.run_number }}
        path: |
          audit-output.log
          logs/
        retention-days: 30
        
    - name: ğŸ“Š Create summary
      if: always()
      run: |
        echo "## ğŸ“Š Resumo da Auditoria DiÃ¡ria" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Data/Hora:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Executor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "audit-output.log" ]; then
          echo "**SaÃ­da da Auditoria:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat audit-output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.audit.outputs.has_discrepancies }}" == "true" ]; then
          echo "## âš ï¸ **ATENÃ‡ÃƒO: DivergÃªncias Detectadas!**" >> $GITHUB_STEP_SUMMARY
          echo "Verifique os logs para mais detalhes." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… **Paridade Total - Sem DivergÃªncias**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ”” Notify on discrepancies
      if: steps.audit.outputs.has_discrepancies == 'true'
      run: |
        echo "ğŸ”” DivergÃªncias detectadas - NotificaÃ§Ã£o enviada"
        # Aqui vocÃª pode adicionar notificaÃ§Ãµes para Slack, Discord, etc.
        # Exemplo para Slack:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"âš ï¸ Auditoria diÃ¡ria detectou divergÃªncias entre Meta API e Supabase!"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: âœ… Success notification
      if: success() && steps.audit.outputs.has_discrepancies == 'false'
      run: |
        echo "âœ… Auditoria concluÃ­da com sucesso - Paridade total confirmada"
        
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ Auditoria falhou - Verifique os logs para mais detalhes"
        # Aqui vocÃª pode adicionar notificaÃ§Ãµes de erro 