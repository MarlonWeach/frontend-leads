name: Sync Dados Meta e Supabase 3x ao dia

on:
  schedule:
    - cron: '0 12,15,19 * * *'  # 9h, 12h, 16h horÃ¡rio de BrasÃ­lia (UTC-3)
  workflow_dispatch:

jobs:
  sync-dados:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
      META_ACCOUNT_ID: ${{ secrets.META_ACCOUNT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > .env.local << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          META_ACCOUNT_ID=${{ secrets.META_ACCOUNT_ID }}
          EOF

      - name: Sync campaigns
        run: node scripts/sync-campaigns-once.js
        continue-on-error: true

      - name: Sync adsets
        run: node scripts/sync-adsets-once.js
        continue-on-error: true

      - name: Sync ads (criativos)
        run: node scripts/update-ad-creatives.js
        continue-on-error: true

      - name: Sync adset insights
        run: node scripts/sync-adset-insights.js
        continue-on-error: true

      - name: Sync ad insights
        run: node scripts/sync-ad-insights.js
        continue-on-error: true

      - name: Sync meta leads
        run: node scripts/import-meta-leads.js
        continue-on-error: true

      - name: Atualizar relacionamentos entre tabelas
        run: node scripts/update-table-relationships.js
        continue-on-error: true

      - name: Verificar status da sincronizaÃ§Ã£o
        run: |
          echo "ðŸ”„ Verificando status da sincronizaÃ§Ã£o..."
          echo "ðŸ“… Data/Hora: $(date)"
          echo "ðŸŒ Timezone: $(date +%Z)"
          echo "ðŸ“Š Ãšltima execuÃ§Ã£o: $(date -u)"
          echo "âœ… Workflow executado com sucesso"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7

      - name: Log success
        if: success()
        run: echo "âœ… SincronizaÃ§Ã£o concluÃ­da com sucesso em $(date)"

      - name: Log failure
        if: failure()
        run: echo "âŒ SincronizaÃ§Ã£o falhou em $(date) - Verificar logs para detalhes" 