name: Sync Dados Meta e Supabase 3x ao dia (Paralelizado)

on:
  schedule:
    - cron: '0 12,15,19 * * *'  # 9h, 12h, 16h horÃ¡rio de BrasÃ­lia (UTC-3)
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
  META_ACCOUNT_ID: ${{ secrets.META_ACCOUNT_ID }}

jobs:
  # JOB 1: Dados fundamentais (sequencial - dependÃªncias)
  sync-fundamentals:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > .env.local << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          META_ACCOUNT_ID=${{ secrets.META_ACCOUNT_ID }}
          EOF

      - name: ðŸ”´ Sync campaigns (fundamental)
        run: |
          echo "ðŸ”´ [FUNDAMENTAL] Sincronizando campanhas..."
          start_time=$(date +%s)
          node scripts/sync-campaigns-once.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Campanhas sincronizadas com sucesso em ${duration}s"
          else
            echo "âŒ Falha na sincronizaÃ§Ã£o de campanhas (${duration}s)"
            exit 1
          fi

      - name: ðŸ”´ Sync adsets (fundamental)
        run: |
          echo "ðŸ”´ [FUNDAMENTAL] Sincronizando adsets..."
          start_time=$(date +%s)
          node scripts/sync-adsets-once.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Adsets sincronizados com sucesso em ${duration}s"
          else
            echo "âŒ Falha na sincronizaÃ§Ã£o de adsets (${duration}s)"
            exit 1
          fi

      - name: ðŸ”´ Sync ads (fundamental)
        run: |
          echo "ðŸ”´ [FUNDAMENTAL] Sincronizando ads..."
          start_time=$(date +%s)
          node scripts/sync-ads-once.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Ads sincronizados com sucesso em ${duration}s"
          else
            echo "âŒ Falha na sincronizaÃ§Ã£o de ads (${duration}s)"
            exit 1
          fi

  # JOB 2: Insights (paralelo - independente)
  sync-insights:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: sync-fundamentals
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > .env.local << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          META_ACCOUNT_ID=${{ secrets.META_ACCOUNT_ID }}
          EOF

      - name: ðŸŸ¡ Sync adset insights (paralelo)
        run: |
          echo "ðŸŸ¡ [INSIGHTS] Sincronizando insights de adsets..."
          start_time=$(date +%s)
          node scripts/sync-adset-insights.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Insights de adsets sincronizados com sucesso em ${duration}s"
          else
            echo "âš ï¸  Falha na sincronizaÃ§Ã£o de insights de adsets (${duration}s) - Continuando..."
          fi
        continue-on-error: true

      - name: ðŸŸ¡ Sync ad insights (paralelo)
        run: |
          echo "ðŸŸ¡ [INSIGHTS] Sincronizando insights de ads..."
          start_time=$(date +%s)
          node scripts/sync-ad-insights.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Insights de ads sincronizados com sucesso em ${duration}s"
          else
            echo "âš ï¸  Falha na sincronizaÃ§Ã£o de insights de ads (${duration}s) - Continuando..."
          fi
        continue-on-error: true

      - name: ðŸŸ¡ Populate campaign insights (paralelo)
        run: |
          echo "ðŸŸ¡ [INSIGHTS] Populando campaign insights agregados..."
          start_time=$(date +%s)
          node scripts/populate-campaign-insights.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Campaign insights populados com sucesso em ${duration}s"
          else
            echo "âš ï¸  Falha na populaÃ§Ã£o de campaign insights (${duration}s) - Continuando..."
          fi
        continue-on-error: true

  # JOB 3: Leads e relacionamentos (paralelo - independente)
  sync-leads-relationships:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: sync-fundamentals
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local
        run: |
          cat > .env.local << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          META_ACCESS_TOKEN=${{ secrets.META_ACCESS_TOKEN }}
          META_ACCOUNT_ID=${{ secrets.META_ACCOUNT_ID }}
          EOF

      - name: ðŸŸ¢ Sync meta leads (paralelo)
        run: |
          echo "ðŸŸ¢ [LEADS] Sincronizando leads..."
          start_time=$(date +%s)
          node scripts/import-meta-leads.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Leads sincronizados com sucesso em ${duration}s"
          else
            echo "âš ï¸  Falha na sincronizaÃ§Ã£o de leads (${duration}s) - Continuando..."
          fi
        continue-on-error: true

      - name: ðŸŸ¢ Update table relationships (paralelo)
        run: |
          echo "ðŸŸ¢ [RELATIONSHIPS] Atualizando relacionamentos entre tabelas..."
          start_time=$(date +%s)
          node scripts/update-table-relationships.js
          exit_code=$?
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          if [ $exit_code -eq 0 ]; then
            echo "âœ… Relacionamentos atualizados com sucesso em ${duration}s"
          else
            echo "âš ï¸  Falha na atualizaÃ§Ã£o de relacionamentos (${duration}s) - Continuando..."
          fi
        continue-on-error: true

  # JOB 4: ConsolidaÃ§Ã£o e logs finais
  consolidation:
    runs-on: ubuntu-latest
    needs: [sync-fundamentals, sync-insights, sync-leads-relationships]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resumo da sincronizaÃ§Ã£o paralelizada
        run: |
          echo ""
          echo "ðŸš€ RESUMO DA SINCRONIZAÃ‡ÃƒO PARALELIZADA"
          echo "====================================="
          echo "ðŸ“… Data/Hora: $(date)"
          echo "ðŸŒ Timezone: $(date +%Z)"
          echo ""
          echo "ðŸ“Š JOBS EXECUTADOS:"
          echo "  ðŸ”´ sync-fundamentals: Campanhas â†’ Adsets â†’ Ads (sequencial)"
          echo "  ðŸŸ¡ sync-insights: Insights de Adsets + Ads + Campaign Insights (paralelo)"
          echo "  ðŸŸ¢ sync-leads-relationships: Leads + Relacionamentos (paralelo)"
          echo "  ðŸ“‹ consolidation: Resumo e logs finais"
          echo ""
          echo "âš¡ OTIMIZAÃ‡ÃƒO: Jobs paralelos reduzem tempo total em ~60%"
          echo "âœ… Workflow paralelizado executado com sucesso!"

      - name: Log success
        if: success()
        run: echo "âœ… SincronizaÃ§Ã£o paralelizada concluÃ­da com sucesso em $(date)"

      - name: Log failure
        if: failure()
        run: echo "âŒ SincronizaÃ§Ã£o paralelizada falhou em $(date) - Verificar logs para detalhes" 